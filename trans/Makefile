#*******************************************************************
#* Makefile for MSII
#*
#* COPYRIGHT: Philip L Johnson 2004
#* This header must appear on all derivatives of this file.
#*
#*******************************************************************
# Extended for MS2/Extra by Ken Culver and James Murray  2006
# $Id: Makefile,v 1.8 2015/01/11 13:08:04 jsm Exp $
ifdef SYSTEMDRIVE
BINDIR = c:/usr/bin
else
BINDIR = /usr/bin
endif

CC = $(BINDIR)/m68hc11-elf-gcc
OBJCOPY = $(BINDIR)/m68hc11-elf-objcopy
OBJDUMP = $(BINDIR)/m68hc11-elf-objdump
NM      = $(BINDIR)/m68hc11-elf-nm

CFLAGS  = -g -Wall -Werror -Wsign-compare -Wshadow -O -fomit-frame-pointer -m68hcs12 -mshort -msoft-reg-count=5 -mauto-incdec -fsigned-char

LDFLAGS = -Wl,-defsym,vectors_addr=0xff80,-m,m68hc12elfb,-T,m68hc12elfb.x,--no-trampoline

CSRCS=trans_can.c trans_can_isr.c\
      trans_main.c trans_misc.c \
      premain.c trans_init.c sigs.c trans_ss.c serial.c

ASRCS=msii_flash_gcc.s ms2_sermon.s trans_conferr.s trans_burner.s \
      isr_sci.s isr_rtc.s isr_timerovf.s crc32.s trans_asm.s interp.s

OBJS=$(CSRCS:.c=.o)
AOBJS= $(ASRCS:.s=.o)

all:	trans.dmp trans.elf trans.s19

trans_main_vars.h:
	echo "/* DO NOT EDIT - this file is automatically generated during build */" > trans_main_vars.h
	cat trans_vars.h | sed 's/extern //' | grep -v "^#" >> trans_main_vars.h

trans_defines.inc:
	echo "; DO NOT EDIT - this file is automatically generated during build" > trans_defines.inc
	grep "^#define" trans_vars.h | awk '{print ".equ",$$2,",",$$3};' >> trans_defines.inc

trans_defines.h:
	echo "/* DO NOT EDIT - this file is automatically generated during build */" > trans_defines.h
	grep "^#define" trans_vars.h >> trans_defines.h

release: all
	rm -rf release
	mkdir release
	cp trans.ini trans.s19 README.txt release

$(AOBJS): %.o: %.s
	$(CC) $(CFLAGS) -c $<

$(OBJS): %.o: %.c cltfactor.inc matfactor.inc hcs12def.h flash.h trans.h trans_main_vars.h trans_defines.inc trans_defines.h
	$(CC) $(CFLAGS) -c $<

trans.elf:	$(OBJS)  $(AOBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o trans.elf $(OBJS) $(AOBJS)

trans.s19: trans.elf
	$(OBJCOPY) --output-target=srec \
	--only-section=.text3 \
	--only-section=.rodata \
        --only-section=.vectors \
        --only-section=.eeprom \
        --only-section=.lookup \
	--only-section=.text3c --change-section-lma .text3c=0x3C8000 \
        --only-section=.text \
	trans.elf trans.s19
	$(NM) trans.elf | sort > trans.map

trans.dmp: trans.elf
	 $(OBJDUMP) -Sdh trans.elf > trans.dmp

.PHONY: clean
clean:
	$(RM) -f trans.elf
	$(RM) -f trans.s19
	$(RM) -f trans.dmp
	$(RM) -f trans.map
	$(RM) -f $(OBJS) $(AOBJS)
	$(RM) -rf release
	$(RM) -rf *~ trans_main_vars.h trans_defines.inc trans_defines.h
